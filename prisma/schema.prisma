generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

enum EmploymentType {
  FULL_TIME
  TEMPORARY
}

enum WorkStatus {
  ACTIVE
  INACTIVE
}

enum LoginType {
  PASSWORD
  GOOGLE
}

enum SectionAction {
  VIEW
  CREATE
  UPDATE
  DELETE
  MANAGE
}

model AttendanceRecord {
  id        Int     @id @default(autoincrement()) @map("id")
  accountId String  @map("account_id")
  date      String  @map("date")
  checkIn   String? @map("check_in")
  checkOut  String? @map("check_out")

  account Account @relation(fields: [accountId], references: [id])

  @@index([accountId])
  @@map("attendance_records")
}

model WorkConfig {
  id                       Int                     @id @default(autoincrement()) @map("id")
  shift                    Int                     @map("shift")
  name                     String?                 @map("name")
  standardCheckIn          String                  @map("standard_check_in")
  standardCheckOut         String                  @map("standard_check_out")
  lateGraceMinutes         Int                     @default(5)  @map("late_grace_minutes")
  earlyLeaveGraceMinutes   Int                     @default(5)  @map("early_leave_grace_minutes")
  overtimeThresholdMinutes Int                     @default(60) @map("overtime_threshold_minutes")
  capacities               WorkShiftCapacity[]

  @@map("work_configs")
}

model Account {
  id           String         @id @default(uuid()) @map("id")
  employeeCode String?        @unique @map("employee_code")
  fullName     String         @map("full_name")
  email        String         @unique
  phone        String?        @map("phone")
  roleKey      String?        @map("role")
  loginType    LoginType      @map("login_type")
  password     String?        @map("password")
  isActive     Boolean        @default(true) @map("is_active")
  createdAt    DateTime       @default(now()) @map("created_at")
  detail       AccountDetail?
  attendance   AttendanceRecord[]
  sectionOverrides AccountSectionOverride[]

  role Role? @relation(fields: [roleKey], references: [key])

  @@map("accounts")
}

model Department {
  id    String @id @default(uuid()) @map("id")
  code  String @unique @map("code")
  name  String @map("name")
  notes String? @map("notes")

  capacities WorkShiftCapacity[]

  @@map("departments")
}

model WorkShiftCapacity {
  id           Int        @id @default(autoincrement()) @map("id")
  workConfigId Int        @map("work_config_id")
  departmentId String     @map("department_id")
  maxEmployees Int        @default(0) @map("max_employees")

  workConfig WorkConfig @relation(fields: [workConfigId], references: [id], onDelete: Cascade)
  department Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)

  @@unique([workConfigId, departmentId], map: "idx_capacity_unique")
  @@map("work_shift_capacities")
}

model AccountDetail {
  id             Int            @id @default(autoincrement()) @map("id")
  accountId      String         @unique @map("account_id")
  department     String?        @map("department")
  position       String?        @map("position")
  cccd           String?        @map("cccd")
  bhxh           String?        @map("bhxh")
  employmentType EmploymentType @default(FULL_TIME) @map("employment_type")
  workStatus     WorkStatus     @default(ACTIVE)    @map("work_status")
  startDate      String?        @map("start_date")
  endDate        String?        @map("end_date")
  shiftCode      String?        @map("shift_code")

  account Account @relation(fields: [accountId], references: [id])

  @@map("account_details")
}

model Role {
  id          Int                @id @default(autoincrement()) @map("id")
  key         String             @unique @map("key")
  name        String             @map("name")
  shortName   String?            @map("short_name")
  description String?            @map("description")
  isDirector  Boolean            @default(false) @map("is_director")
  accounts    Account[]
  permissions RolePermission[]
  sectionAccess RoleSectionAccess[]

  @@map("roles")
}

model Permission {
  id          Int                @id @default(autoincrement()) @map("id")
  key         String             @unique @map("key")
  name        String             @map("name")
  description String?            @map("description")
  roles       RolePermission[]

  @@map("permissions")
}

model RolePermission {
  roleId       Int  @map("role_id")
  permissionId Int  @map("permission_id")

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

// Danh mục chức năng (dùng cho sidebar và phân quyền)
model AppSection {
  id         Int            @id @default(autoincrement())
  key        String         @unique
  label      String
  path       String
  group      String?
  sortOrder  Int            @default(0) @map("sort_order")
  isEnabled  Boolean        @default(true) @map("is_enabled")
  actions    SectionAction[]
  createdAt  DateTime       @default(now()) @map("created_at")
  updatedAt  DateTime       @updatedAt      @map("updated_at")

  roleAccess        RoleSectionAccess[]
  accountOverrides  AccountSectionOverride[]

  @@map("app_sections")
}

// Quyền hiển thị + hành động theo role cho mỗi section
model RoleSectionAccess {
  id             Int            @id @default(autoincrement())
  roleId         Int            @map("role_id")
  sectionId      Int            @map("section_id")
  allowedActions SectionAction[] @map("allowed_actions")
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt      @map("updated_at")

  role    Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  section AppSection @relation(fields: [sectionId], references: [id], onDelete: Cascade)

  @@unique([roleId, sectionId])
  @@index([sectionId])
  @@map("role_section_access")
}

// Override riêng cho tài khoản (tùy chọn)
model AccountSectionOverride {
  id             Int            @id @default(autoincrement())
  accountId      String         @map("account_id")
  sectionId      Int            @map("section_id")
  allowedActions SectionAction[] @map("allowed_actions")
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt      @map("updated_at")

  account Account    @relation(fields: [accountId], references: [id], onDelete: Cascade)
  section AppSection @relation(fields: [sectionId], references: [id], onDelete: Cascade)

  @@unique([accountId, sectionId])
  @@index([sectionId])
  @@map("account_section_overrides")
}
